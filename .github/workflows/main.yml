name: CI


on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      website_url:
        description: "URL вашего сайта (для TWA/Bubblewrap)"
        required: false
        default: "https://mybenzin15102025.vercel.app"


jobs:
  web-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'


      - name: Install dependencies
        run: npm install --legacy-peer-deps


      - name: Build Next.js app
        run: npm run build


      - name: Run tests
        run: echo "Tests would run here"


  android-apk:
    runs-on: ubuntu-latest
    needs: web-ci

    steps:
      - uses: actions/checkout@v4

      # Java + Android SDK
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Setup Node.js для Bubblewrap
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Bubblewrap CLI
        run: npm i -g @bubblewrap/cli

      # Создаем TWA проект
      - name: Generate TWA project
        env:
          WEBSITE_URL: ${{ github.event.inputs.website_url || 'https://mybenzin15102025.vercel.app' }}
        run: |
          echo "Using WEBSITE_URL=$WEBSITE_URL"
          
          # Создаем минимальный twa.manifest.json
          mkdir -p twa-project
          cat > twa-project/twa-manifest.json <<EOF
          {
            "packageId": "com.mybenzin.app",
            "host": "$WEBSITE_URL",
            "name": "Mybenzin",
            "launcherName": "Mybenzin",
            "display": "standalone",
            "themeColor": "#3B82F6",
            "navigationColor": "#1E40AF",
            "backgroundColor": "#FFFFFF",
            "enableNotifications": true,
            "startUrl": "/",
            "iconUrl": "$WEBSITE_URL/icon-512.png",
            "maskableIconUrl": "$WEBSITE_URL/icon-512.png",
            "monochromeIconUrl": "$WEBSITE_URL/icon-512.png",
            "splashScreenFadeOutDuration": 300,
            "signingKey": {
              "path": "./android.keystore",
              "alias": "android"
            },
            "appVersionName": "1.0.0",
            "appVersionCode": 1,
            "shortcuts": [],
            "generatorApp": "bubblewrap-cli",
            "webManifestUrl": "$WEBSITE_URL/manifest.json",
            "fallbackType": "customtabs",
            "features": {},
            "alphaDependencies": {
              "enabled": false
            },
            "enableSiteSettingsShortcut": true,
            "isChromeOSOnly": false,
            "isMetaQuest": false
          }
          EOF

      - name: Initialize Bubblewrap project
        working-directory: twa-project
        run: |
          # Инициализируем проект из манифеста
          bubblewrap init --manifest=./twa-manifest.json || true

      - name: Build TWA debug APK
        working-directory: twa-project
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
        run: |
          # Устанавливаем переменные окружения для неинтерактивного режима
          export CI=true
          
          # Используем уже установленный JDK 17
          echo "Using JAVA_HOME: $JAVA_HOME"
          java -version
          
          # Собираем debug APK через Gradle напрямую (пропускаем bubblewrap build)
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew assembleDebug --stacktrace
          else
            echo "Error: gradlew not found after bubblewrap init"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: mybenzin-android-apk
          path: |
            twa-project/app/build/outputs/apk/debug/*.apk
            twa-project/app/build/outputs/apk/release/*.apk
          if-no-files-found: warn
