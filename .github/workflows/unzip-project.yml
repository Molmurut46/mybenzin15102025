name: –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ ZIP

on:
  push:
    branches:
      - main
      - master
    paths:
      - '*.zip'

jobs:
  unzip:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: –ù–∞–π—Ç–∏ ZIP —Ñ–∞–π–ª—ã
        id: find-zip
        run: |
          ZIP_FILES=$(find . -maxdepth 1 -name "*.zip" -type f)
          if [ -z "$ZIP_FILES" ]; then
            echo "–ù–µ—Ç ZIP —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏"
            exit 0
          fi
          echo "zip_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ZIP_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å ZIP –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        if: steps.find-zip.outputs.zip_files != ''
        run: |
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ ZIP —Ñ–∞–π–ª–∞
          for ZIP_FILE in *.zip; do
            [ -f "$ZIP_FILE" ] || continue
            
            echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ $ZIP_FILE..."
            
            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            TEMP_DIR=$(mktemp -d)
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            unzip -q "$ZIP_FILE" -d "$TEMP_DIR"
            
            # –£–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã
            find "$TEMP_DIR" -name ".DS_Store" -type f -delete
            find "$TEMP_DIR" -name "__MACOSX" -type d -exec rm -rf {} + 2>/dev/null || true
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            # –ï—Å–ª–∏ –≤ ZIP –µ—Å—Ç—å –æ–¥–Ω–∞ –∫–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –Ω–µ—ë
            if [ $(ls -A "$TEMP_DIR" | wc -l) -eq 1 ] && [ -d "$TEMP_DIR"/* ]; then
              ROOT_DIR=$(ls -A "$TEMP_DIR")
              cp -rf "$TEMP_DIR/$ROOT_DIR"/* .
              cp -rf "$TEMP_DIR/$ROOT_DIR"/.[!.]* . 2>/dev/null || true
            else
              cp -rf "$TEMP_DIR"/* .
              cp -rf "$TEMP_DIR"/.[!.]* . 2>/dev/null || true
            fi
            
            # –û—á–∏—Å—Ç–∫–∞
            rm -rf "$TEMP_DIR"
            
            # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π ZIP
            git rm "$ZIP_FILE"
            
            echo "‚úÖ $ZIP_FILE —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
          done
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -A
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏"
            exit 0
          fi
          
          # –ö–æ–º–º–∏—Ç–∏–º
          git commit -m "üóúÔ∏è –ê–≤—Ç–æ—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ ZIP [skip ci]"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
      
      - name: –†–µ–∑—É–ª—å—Ç–∞—Ç
        if: success()
        run: echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω –∏ –æ–±–Ω–æ–≤–ª—ë–Ω"